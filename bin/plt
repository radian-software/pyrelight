#!/usr/bin/env bash

set -e
set -o pipefail
unset CDPATH

# https://stackoverflow.com/a/20053121/3538165
function quote() {
    sed -e "s/'/'\\\\''/g; 1s/^/'/; \$s/\$/'/"
}

function quote_args() {
    while (( $# > 0 )); do
        echo -n "$1" | quote
        if (( $# > 1 )); then
            echo -n " "
        fi
        shift
    done
    echo
}

script_path="${BASH_SOURCE[0]}"
script_dir="$(dirname "${script_path}")"
src_dir="$(cd -P -- "${script_dir}/.." && pwd -P)"

msg="$(quote_args "$@")"

cd "${src_dir}"
if ! nc -N -U server <<< "${msg}" 2>/dev/null; then
    rm -f server
    python3 -m pyrelight &>server.log &
    for i in {1..50}; do
        if [[ -S server ]]; then
            nc -N -U server <<< "${msg}"
            exit
        fi
        sleep 0.01
    done
    echo "failed to start server!" >&2
    if [[ -s server.log ]]; then
        echo "here is the error message we got from the server:" >&2
        cat server.log | sed 's/^/  ' >&2
    else
        echo "unfortunately, we didn't get any diagnostic info from the server." >&2
    fi
fi
